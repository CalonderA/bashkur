
function toggleChat() {
    const widget = document.getElementById('ai-widget');
    const launcher = document.getElementById('ai-launcher');
    
    if (widget.style.display === 'flex') {
        widget.classList.remove('active');
        setTimeout(() => widget.style.display = 'none', 300);
        launcher.style.display = 'block';
    } else {
        widget.style.display = 'flex';
        setTimeout(() => widget.classList.add('active'), 10);
        launcher.style.display = 'none';
        
        setTimeout(() => document.getElementById('user-input').focus(), 100);
    }
}

function handleKeyPress(event) {
    if (event.key === 'Enter') {
        sendMessage();
    }
}

function sendMessage() {
    const input = document.getElementById('user-input');
    const text = input.value.trim();
    
    if (!text) return;
    
    addMessage(text, 'user');
    input.value = '';
    
    setTimeout(async () => {
        let response = null;
        
        try {
            const { gigaChatToken } = await ensureTokens();
            if (gigaChatToken) {
                 const chatResponse = await fetch('https://gigachat.devices.sberbank.ru/api/v1/chat/completions', {
                     method: 'POST',
                     headers: {
                         'Authorization': `Bearer ${gigaChatToken}`,
                         'Content-Type': 'application/json'
                     },
                     body: JSON.stringify({
                         model: "GigaChat",
                         messages: [
                             { role: "system", content: "–¢—ã ‚Äî –ø–æ–ª–µ–∑–Ω—ã–π AI-–≥–∏–¥ –ø–æ –ë–∞—à–∫–æ—Ä—Ç–æ—Å—Ç–∞–Ω—É –∏ –±—Ä–µ–Ω–¥—É T2. –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ –∏ –≤–µ–∂–ª–∏–≤–æ." },
                             { role: "user", content: text }
                         ],
                         temperature: 0.7
                     })
                 });
                 
                 if (chatResponse.ok) {
                     const data = await chatResponse.json();
                     response = data.choices[0].message.content;
                 } else {
                     console.warn("GigaChat failed, using fallback");
                 }
            }
        } catch (e) {
            console.warn("GigaChat Error:", e);
        }
        
        if (!response) {
            response = getAIResponse(text);
        }

        addMessage(response, 'bot');
    }, 800);
}

function addMessage(text, sender) {
    const container = document.getElementById('ai-messages');
    const div = document.createElement('div');
    div.classList.add('message', sender === 'user' ? 'user-message' : 'bot-message');
    div.textContent = text;
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
}

function getAIResponse(input) {
    const lower = input.toLowerCase();
    const contains = (keywords) => keywords.some(k => lower.includes(k));

    if (contains(['–ø—Ä–∏–≤–µ—Ç', '–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π', '—Ö–∞–π', 'hello'])) {
        return "“∫–∞—É–º—ã“ª—ã“ì—ã“ô! –Ø –≤–∞—à –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –≥–∏–¥ –ø–æ –ë–∞—à–∫–æ—Ä—Ç–æ—Å—Ç–∞–Ω—É –∏ —É—Å–ª—É–≥–∞–º T2. –û —á–µ–º —Ö–æ—Ç–∏—Ç–µ —É–∑–Ω–∞—Ç—å?";
    }
    if (contains(['–∫—Ç–æ —Ç—ã', '–∫–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç', '—á—Ç–æ —Ç—ã —É–º–µ–µ—à—å'])) {
        return "–Ø ‚Äî AI-–ø–æ–º–æ—â–Ω–∏–∫, —Å–æ–∑–¥–∞–Ω–Ω—ã–π –æ–±—ä–µ–¥–∏–Ω—è—Ç—å —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ T2 –∏ –∫—É–ª—å—Ç—É—Ä—É –ë–∞—à–∫–∏—Ä–∏–∏. –Ø –∑–Ω–∞—é –ª–µ–≥–µ–Ω–¥—ã, —Ä–µ—Ü–µ–ø—Ç—ã –∏ —Ç–∞—Ä–∏—Ñ—ã!";
    }
    if (contains(['–¥–µ–ª–∞', '–∫–∞–∫ –∂–∏–∑–Ω—å', '–∫–∞–∫ —Å–∞–º'])) {
        return "–£ –º–µ–Ω—è –≤—Å—ë –æ—Ç–ª–∏—á–Ω–æ! –°–∫–æ—Ä–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö ‚Äî –∫–∞–∫ 4G –æ—Ç T2. –ê —É –≤–∞—Å –∫–∞–∫?";
    }

    if (contains(['—Ç2', '—Å–≤—è–∑—å', '–∏–Ω—Ç–µ—Ä–Ω–µ—Ç', '—Å–µ—Ç—å', '–ª–æ–≤–∏—Ç'])) {
        return "T2 –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –Ω–∞–¥–µ–∂–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ –ø–æ –≤—Å–µ–π –ë–∞—à–∫–∏—Ä–∏–∏. –ú—ã –ª–æ–≤–∏–º –¥–∞–∂–µ —Ç–∞–º, –≥–¥–µ –ø–∞—Å—É—Ç –ª–æ—à–∞–¥–µ–π –Ω–∞ —Å–∫–ª–æ–Ω–∞—Ö –£—Ä–∞–ª–∞! üöÄ";
    }
    if (contains(['—Ç–∞—Ä–∏—Ñ', '—Ü–µ–Ω–∞', '—Å–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç'])) {
        return "–£ T2 —á–µ—Å—Ç–Ω—ã–µ —Ç–∞—Ä–∏—Ñ—ã –±–µ–∑ —Å–∫—Ä—ã—Ç—ã—Ö —É—Å–ª–æ–≤–∏–π. –í—ã –ø–ª–∞—Ç–∏—Ç–µ —Ç–æ–ª—å–∫–æ –∑–∞ —Ç–æ, —á–µ–º –ø–æ–ª—å–∑—É–µ—Ç–µ—Å—å. –ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–π –ø–æ —Ä–µ—Å–ø—É–±–ª–∏–∫–µ.";
    }
    if (contains(['—Å–∏–º', 'sim', '–∫—É–ø–∏—Ç—å'])) {
        return "–°—Ç–∞—Ç—å –∞–±–æ–Ω–µ–Ω—Ç–æ–º T2 –ª–µ–≥–∫–æ! –ó–∞–∫–∞–∂–∏—Ç–µ SIM-–∫–∞—Ä—Ç—É –æ–Ω–ª–∞–π–Ω –∏–ª–∏ –∑–∞–π–¥–∏—Ç–µ –≤ –ª—é–±–æ–π —Å–∞–ª–æ–Ω —Å–≤—è–∑–∏ –≤ –£—Ñ–µ –∏ –¥—Ä—É–≥–∏—Ö –≥–æ—Ä–æ–¥–∞—Ö.";
    }

    if (contains(['—É—Ä–∞–ª', '–≥–æ—Ä—ã', '–∏—Ä–µ–º–µ–ª—å', '—è–º–∞–Ω—Ç–∞—É'])) {
        return "–£—Ä–∞–ª—å—Å–∫–∏–µ –≥–æ—Ä—ã ‚Äî —Å—Ç–∞—Ä–µ–π—à–∏–µ –≤ –º–∏—Ä–µ. –°–≤—è—â–µ–Ω–Ω–∞—è –≥–æ—Ä–∞ –ò—Ä–µ–º–µ–ª—å –¥–∞—Ä–∏—Ç —Å–∏–ª—É —Ç–µ–º, –∫—Ç–æ –ø–æ–¥–Ω–∏–º–∞–µ—Ç—Å—è —Å —á–∏—Å—Ç—ã–º —Å–µ—Ä–¥—Ü–µ–º.";
    }
    if (contains(['–ø–µ—â–µ—Ä', '—à—É–ª—å–≥–∞–Ω', '–∫–∞–ø–æ–≤'])) {
        return "–ü–µ—â–µ—Ä–∞ –®—É–ª—å–≥–∞–Ω-–¢–∞—à (–ö–∞–ø–æ–≤–∞) –∏–∑–≤–µ—Å—Ç–Ω–∞ –Ω–∞ –≤–µ—Å—å –º–∏—Ä –¥—Ä–µ–≤–Ω–∏–º–∏ –Ω–∞—Å–∫–∞–ª—å–Ω—ã–º–∏ —Ä–∏—Å—É–Ω–∫–∞–º–∏ –º–∞–º–æ–Ω—Ç–æ–≤. –≠—Ç–æ –º–µ—Å—Ç–æ —Å–∏–ª—ã.";
    }
    if (contains(['—É—Ñ–∞', '—Å—Ç–æ–ª–∏—Ü–∞', '–≥–æ—Ä–æ–¥'])) {
        return "–£—Ñ–∞ ‚Äî —Å—Ç–æ–ª–∏—Ü–∞ –Ω–∞—à–µ–π —Ä–µ—Å–ø—É–±–ª–∏–∫–∏. –ì–æ—Ä–æ–¥ –Ω–∞ —Å–µ–º–∏ —Ö–æ–ª–º–∞—Ö, –≥–¥–µ –≤—Å—Ç—Ä–µ—á–∞—é—Ç—Å—è —Ä–µ–∫–∏ –ë–µ–ª–∞—è –∏ –£—Ñ–∞. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–æ—Å–µ—Ç–∏—Ç–µ –ø–∞–º—è—Ç–Ω–∏–∫ –°–∞–ª–∞–≤–∞—Ç—É –Æ–ª–∞–µ–≤—É!";
    }
    if (contains(['–Ω–∞—Å–µ–ª–µ–Ω–∏', '—Å–∫–æ–ª—å–∫–æ –ª—é–¥–µ–π', '–∂–∏—Ç–µ–ª–µ–π'])) {
        return "–í –ë–∞—à–∫–æ—Ä—Ç–æ—Å—Ç–∞–Ω–µ –ø—Ä–æ–∂–∏–≤–∞–µ—Ç –±–æ–ª–µ–µ 4 –º–∏–ª–ª–∏–æ–Ω–æ–≤ —á–µ–ª–æ–≤–µ–∫. –≠—Ç–æ –æ–¥–Ω–∞ –∏–∑ —Å–∞–º—ã—Ö –Ω–∞—Å–µ–ª–µ–Ω–Ω—ã—Ö —Ä–µ—Å–ø—É–±–ª–∏–∫ –†–æ—Å—Å–∏–∏, –≥–¥–µ –¥—Ä—É–∂–Ω–æ –∂–∏–≤—É—Ç –±–∞—à–∫–∏—Ä—ã, —Ä—É—Å—Å–∫–∏–µ, —Ç–∞—Ç–∞—Ä—ã –∏ –º–Ω–æ–≥–∏–µ –¥—Ä—É–≥–∏–µ –Ω–∞—Ä–æ–¥—ã.";
    }

    if (contains(['–±–∞—Ç—ã—Ä', '—Å–∞–ª–∞–≤–∞—Ç', '–≥–µ—Ä–æ–π'])) {
        return "–°–∞–ª–∞–≤–∞—Ç –Æ–ª–∞–µ–≤ ‚Äî –Ω–∞—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –≥–µ—Ä–æ–π –ë–∞—à–∫–æ—Ä—Ç–æ—Å—Ç–∞–Ω–∞, –ø–æ—ç—Ç –∏ –≤–æ–∏–Ω. –ï–≥–æ –æ–±—Ä–∞–∑ —Å–∏–º–≤–æ–ª–∏–∑–∏—Ä—É–µ—Ç —Å–≤–æ–±–æ–¥—É –∏ –¥—É—Ö –Ω–∞—Ä–æ–¥–∞.";
    }
    if (contains(['–∫—É—Ä–∞–π', '–º—É–∑—ã–∫–∞', '–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç'])) {
        return "–ö—É—Ä–∞–π ‚Äî —ç—Ç–æ –¥—É—à–∞ –±–∞—à–∫–∏—Ä. –¢—Ä–æ—Å—Ç–Ω–∏–∫–æ–≤–∞—è —Ñ–ª–µ–π—Ç–∞, —á—å—è –º–µ–ª–æ–¥–∏—è —Å–ø–æ—Å–æ–±–Ω–∞ –ø–µ—Ä–µ–¥–∞—Ç—å —à—É–º –≤–µ—Ç—Ä–∞ –∏ —Ç–æ–ø–æ—Ç –∫–æ–ø—ã—Ç.";
    }
    if (contains(['–ª–µ–≥–µ–Ω–¥', '—Å–∫–∞–∑–∫', '—ç–ø–æ—Å'])) {
        return "–≠–ø–æ—Å '–£—Ä–∞–ª-–±–∞—Ç—ã—Ä' —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–µ—Ç –æ –±–æ—Ä—å–±–µ –¥–æ–±—Ä–∞ —Å–æ –∑–ª–æ–º. –≠—Ç–æ –º–æ–Ω—É–º–µ–Ω—Ç–∞–ª—å–Ω–æ–µ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ, –≤–∫–ª—é—á–µ–Ω–Ω–æ–µ –≤ —Å–ø–∏—Å–æ–∫ —à–µ–¥–µ–≤—Ä–æ–≤ –Æ–ù–ï–°–ö–û.";
    }

    if (contains(['–µ–¥', '–∫—É—Ö–Ω', '–±–ª—é–¥', '–ø–æ–µ—Å—Ç—å'])) {
        return "–ë–∞—à–∫–∏—Ä—Å–∫–∞—è –∫—É—Ö–Ω—è ‚Äî —ç—Ç–æ –ø—Ä–∞–∑–¥–Ω–∏–∫ –≤–∫—É—Å–∞! –ë–µ—à–±–∞—Ä–º–∞–∫, —á–∞–∫-—á–∞–∫, –∑—É—Ä-–±—ç–ª–∏—à, –∫—ã—Å—Ç—ã–±—ã–π... –í—ã —É–∂–µ –ø—Ä–æ–≥–æ–ª–æ–¥–∞–ª–∏—Å—å? üòã";
    }
    if (contains(['–º–µ–¥', '–º—ë–¥', '—Å–ª–∞–¥'])) {
        return "–ë–∞—à–∫–∏—Ä—Å–∫–∏–π –º—ë–¥ ‚Äî –ª—É—á—à–∏–π –≤ –º–∏—Ä–µ! –û–Ω —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –¥–∏–∫–∏–º–∏ –ø—á–µ–ª–∞–º–∏ (–±–æ—Ä—Ç–µ–≤–æ–µ –ø—á–µ–ª–æ–≤–æ–¥—Å—Ç–≤–æ) –∏ –æ–±–ª–∞–¥–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏ —Ü–µ–ª–µ–±–Ω—ã–º–∏ —Å–≤–æ–π—Å—Ç–≤–∞–º–∏.";
    }
    if (contains(['—á–∞–∫', '—á–∞–∫-—á–∞–∫'])) {
        return "–ß–∞–∫-—á–∞–∫ ‚Äî —Å–∏–º–≤–æ–ª –≥–æ—Å—Ç–µ–ø—Ä–∏–∏–º—Å—Ç–≤–∞. –°–ª–∞–¥–∫–æ–µ –ª–∞–∫–æ–º—Å—Ç–≤–æ –∏–∑ —Ç–µ—Å—Ç–∞ –∏ –º–µ–¥–∞, –∫–æ—Ç–æ—Ä—ã–º –≤—Å—Ç—Ä–µ—á–∞—é—Ç –¥–æ—Ä–æ–≥–∏—Ö –≥–æ—Å—Ç–µ–π.";
    }
    if (contains(['–∫—É–º—ã—Å', '–Ω–∞–ø–∏—Ç–æ–∫'])) {
        return "–ö—É–º—ã—Å ‚Äî —Ü–µ–ª–µ–±–Ω—ã–π –Ω–∞–ø–∏—Ç–æ–∫ –∏–∑ –∫–æ–±—ã–ª—å–µ–≥–æ –º–æ–ª–æ–∫–∞. –û–Ω –ø—Ä–∏–¥–∞–µ—Ç —Å–∏–ª –∏ –±–æ–¥—Ä–æ—Å—Ç–∏ –¥—É—Ö–∞!";
    }

    if (contains(['—Å–ª–æ–≤–∞—Ä—å', '—É—á–∏—Ç—å', '—Å–ª–æ–≤–æ'])) {
        return "–í—ã –º–æ–∂–µ—Ç–µ –≤—ã—É—á–∏—Ç—å –±–∞–∑–æ–≤—ã–µ —Å–ª–æ–≤–∞ –ø—Ä—è–º–æ –∑–¥–µ—Å—å! –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å–≤–µ—Ä—Ö—É, —á—Ç–æ–±—ã —É—Å–ª—ã—à–∞—Ç—å '–†”ô—Ö–º”ô—Ç' –∏–ª–∏ '–Ø—Ä–∞—Ç–∞–º'.";
    }
    if (contains(['—Å–ø–∞—Å–∏–±–æ', '—Ä–∞—Ö–º–∞—Ç'])) {
        return "–ü–æ-–±–∞—à–∫–∏—Ä—Å–∫–∏ '–°–ø–∞—Å–∏–±–æ' –±—É–¥–µ—Ç '–†”ô—Ö–º”ô—Ç'. –≠—Ç–æ —Å–ª–æ–≤–æ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –ª—é–±—ã–µ –¥–≤–µ—Ä–∏!";
    }
    if (contains(['–ª—é–±–ª—é'])) {
        return "–°–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ —Å–ª–æ–≤–æ: '–Ø—Ä–∞—Ç–∞–º' (–õ—é–±–ª—é). –°–∫–∞–∂–∏—Ç–µ —ç—Ç–æ —Å–≤–æ–∏–º –±–ª–∏–∑–∫–∏–º —Å–µ–≥–æ–¥–Ω—è.";
    }

    const fallbacks = [
        "–û—á–µ–Ω—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –≤–æ–ø—Ä–æ—Å! –í –ë–∞—à–∫–∏—Ä–∏–∏ —Å—Ç–æ–ª—å–∫–æ —Ç–∞–π–Ω... –°–ø—Ä–æ—Å–∏—Ç–µ –ª—É—á—à–µ –ø—Ä–æ –ø–µ—â–µ—Ä—É –®—É–ª—å–≥–∞–Ω-–¢–∞—à –∏–ª–∏ –≤–∫—É—Å–Ω—ã–π –º—ë–¥.",
        "–Ø –ø–æ–∫–∞ —É—á—É—Å—å, –Ω–æ —Ç–æ—á–Ω–æ –∑–Ω–∞—é: —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–æ–º T2 –≤—ã –Ω–∞–π–¥–µ—Ç–µ –æ—Ç–≤–µ—Ç –≤ —Å–µ–∫—É–Ω–¥—É! –ê —è –º–æ–≥—É —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –ø—Ä–æ –∫—É—Ä–∞–π.",
        "–•–º, —ç—Ç–æ —Å–ª–æ–∂–Ω–æ. –ù–æ –∑–Ω–∞–µ—Ç–µ, —á—Ç–æ –ø—Ä–æ—Å—Ç–æ? –ü—É—Ç–µ—à–µ—Å—Ç–≤–æ–≤–∞—Ç—å –ø–æ –ë–∞—à–∫–∏—Ä–∏–∏ —Å –Ω–∞–¥–µ–∂–Ω–æ–π —Å–≤—è–∑—å—é T2!",
        "–ë–∞—à–∫–æ—Ä—Ç–æ—Å—Ç–∞–Ω —É–¥–∏–≤–∏—Ç–µ–ª–µ–Ω. –•–æ—Ç–∏—Ç–µ —Ä–∞—Å—Å–∫–∞–∂—É –ª–µ–≥–µ–Ω–¥—É –æ —Å–µ–º–∏ –¥–µ–≤—É—à–∫–∞—Ö –∏–ª–∏ –ø—Ä–æ –≥–æ—Ä—É –ò—Ä–µ–º–µ–ª—å?"
    ];
    
    return fallbacks[Math.floor(Math.random() * fallbacks.length)];
}
